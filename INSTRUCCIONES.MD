# Instrucciones de Uso - Patr√≥n Saga con Docker y Traefik

## üìã Requisitos Previos

- Docker y Docker Compose instalados
- Red Docker externa `carlosred` creada (ver instrucciones abajo)

---

## üåê Paso 1: Iniciar Traefik (Reverse Proxy)

Traefik debe estar corriendo **antes** de iniciar los microservicios.

```bash
cd traefik
docker compose up -d
```

**Verificar que Traefik est√° corriendo:**
```bash
docker ps | grep traefik
```

> **Importante:** Traefik gestiona todo el enrutamiento HTTP hacia los microservicios.

---

## üîå Paso 2: Crear la Red Docker (solo primera vez)

Los microservicios y Traefik se comunican a trav√©s de la red `carlosred`:

```bash
docker network create carlosred
```

> Si ya existe, ver√°s un mensaje indic√°ndolo. Puedes continuar sin problemas.

---

## üöÄ Paso 3: Construir e Iniciar los Microservicios

Desde la ra√≠z del proyecto:

```bash
docker compose up -d --build
```

**Verificar que todos los servicios est√°n corriendo:**
```bash
docker compose ps
```

Deber√≠as ver 5 servicios:
- `ms-catalogo`
- `ms-compras`
- `ms-pagos`
- `ms-inventario`
- `orquestador`

---

## üß™ Paso 4: Probar el Sistema

### Health Checks (verificar conectividad a trav√©s de Traefik)

```bash
# Orquestador
curl http://localhost/orquestador/health

# Cat√°logo
curl http://localhost/ms_catalogo/health

# Compras
curl http://localhost/ms_compras/health

# Pagos
curl http://localhost/ms_pagos/health

# Inventario
curl http://localhost/ms_inventario/health
```

**Respuesta esperada:**
```json
{"status": "ok", "service": "nombre-del-servicio"}
```

---

## üõí Paso 5: Realizar una Compra (Prueba del Patr√≥n Saga)

### Validaci√≥n de Cat√°logo

El sistema **valida que el producto existe** en el cat√°logo **antes** de ejecutar la saga.
Si el producto no existe, la transacci√≥n falla inmediatamente sin crear compensaciones.

### Patr√≥n Retry Implementado

El orquestador implementa un **patr√≥n de reintentos** para manejar fallos transitorios:
- **M√°ximo 3 intentos** por cada operaci√≥n (compras y pagos)
- **Backoff exponencial**: 1s ‚Üí 2s ‚Üí 4s entre intentos
- Solo se aplica a fallos transitorios (no a errores permanentes como falta de stock)

### Ejemplo de Compra

```bash
curl -X POST http://localhost/orquestador/compra \
  -H "Content-Type: application/json" \
  -d '{"usuario_id": "user123", "producto": "Laptop", "monto": 1500.00}'
```

**Par√°metros requeridos:**
- `usuario_id`: Identificador del usuario
- `producto`: Nombre del producto a comprar (debe existir en cat√°logo)
- `monto`: Monto a pagar

**Casos posibles:**

#### ‚úÖ Transacci√≥n Exitosa (50% probabilidad)
```json
{
  "success": true,
  "mensaje": "Saga completada exitosamente",
  "detalles": {
    "producto": "Laptop Gamer",
    "precio": 1200.0,
    "compra_id": "abc-123",
    "pago_id": "xyz-789",
    "reserva_id": "def-456"
  }
}
```

#### ‚ùå Producto No Encontrado (validaci√≥n temprana)
```json
{
  "success": false,
  "error": "Producto 'iPhone' no encontrado en cat√°logo",
  "compensaciones": [],
  "paso_fallido": "catalogo"
}
```

#### ‚ùå Fallo con Compensaci√≥n (despu√©s de reintentos)
```json
{
  "success": false,
  "error": "Fallo en el paso de pagos despu√©s de 3 intentos",
  "compensaciones": ["compras"],
  "mensaje": "La transacci√≥n ha sido revertida"
}
```

#### ‚ùå Fallo por Stock Insuficiente
```json
{
  "success": false,
  "error": "Stock insuficiente para LAPTOP",
  "compensaciones": ["pagos", "compras"],
  "paso_fallido": "inventario"
}
```

---

## üìä Paso 6: Consultar Estado de los Servicios

### Ver Inventario Disponible
```bash
curl http://localhost/ms_inventario/inventario
```

**Respuesta:**
```json
{
  "LAPTOP": {"nombre": "Laptop Gamer", "precio": 1200.0, "stock": 5, "reservado": 0},
  "MOUSE": {"nombre": "Mouse Inal√°mbrico", "precio": 25.99, "stock": 10, "reservado": 0},
  "TECLADO": {"nombre": "Teclado Mec√°nico", "precio": 89.99, "stock": 3, "reservado": 0},
  "AURICULARES": {"nombre": "Auriculares Bluetooth", "precio": 59.99, "stock": 15, "reservado": 0},
  "MONITOR": {"nombre": "Monitor 27 pulgadas", "precio": 350.0, "stock": 8, "reservado": 0}
}
```

### Ver Compras Activas
```bash
curl http://localhost/ms_compras/compras
```

**Respuesta:**
```json
{
  "compras": [
    {
      "compra_id": "abc-123",
      "usuario_id": "user123",
      "producto": "Laptop Gamer",
      "estado": "confirmada"
    }
  ],
  "total_activas": 1,
  "total_general": 3
}
```

### Ver Pagos Registrados
```bash
curl http://localhost/ms_pagos/pagos
```

**Respuesta:**
```json
{
  "pagos": [
    {
      "pago_id": "xyz-789",
      "usuario_id": "user123",
      "monto": 1200.0,
      "compra_id": "abc-123",
      "estado": "aprobado",
      "fecha": "2025-11-26T10:30:45.123456"
    }
  ],
  "total": 1
}
```

---

## üîÑ Paso 7: Observar Compensaciones del Patr√≥n Saga

Ejecuta varias compras para ver tanto transacciones exitosas como compensaciones:

```bash
# Ejecutar m√∫ltiples veces
curl -X POST http://localhost/orquestador/compra \
  -H "Content-Type: application/json" \
  -d '{"usuario_id": "user456", "producto": "Mouse", "monto": 25.99}'
```

> **Nota:** El sistema tiene una **probabilidad del 50%** de √©xito en compras y pagos para facilitar las pruebas.
> Con el patr√≥n Retry (3 intentos), la probabilidad de √©xito final es mayor (~87.5%).
> Ejecuta varias veces para observar:
> - ‚úÖ Transacciones exitosas (con o sin reintentos)
> - ‚ùå Fallos con compensaciones autom√°ticas
> - üîÑ Reintentos en los logs antes de √©xito/fallo final

---

## üìä Paso 8: Observar los Logs de Docker

Ver logs en tiempo real de todos los servicios:

```bash
docker compose logs -f
```

Ver logs de un servicio espec√≠fico:

```bash
docker compose logs -f orquestador
docker compose logs -f ms-compras
docker compose logs -f ms-pagos
docker compose logs -f ms-inventario
```

**Ejemplo de logs exitosos (con reintentos):**
```
orquestador  | üé¨ Iniciando Saga para usuario user123
orquestador  | ‚è≥ Validando producto 'Laptop' en cat√°logo...
orquestador  | ‚úÖ Producto encontrado: Laptop Gamer ($1200.0)
orquestador  | ‚è≥ Paso 1/4: Creando compra...
orquestador  | ‚ö†Ô∏è  Intento 1/3 fall√≥ para compras. Esperando 1s antes de reintentar...
orquestador  | üîÑ Reintentando compras (intento 2/3)...
orquestador  | ‚úÖ Paso 1/4: Compra creada - ID: abc-123
orquestador  | ‚è≥ Paso 2/4: Procesando pago...
orquestador  | ‚úÖ Paso 2/4: Pago procesado - ID: xyz-789
orquestador  | ‚è≥ Paso 3/4: Reservando inventario...
orquestador  | ‚úÖ Paso 3/4: Inventario reservado - ID: def-456
orquestador  | üéâ Saga completada exitosamente
```

**Ejemplo de logs con compensaci√≥n (despu√©s de agotar reintentos):**
```
orquestador  | üé¨ Iniciando Saga para usuario user123
orquestador  | ‚è≥ Validando producto 'Mouse' en cat√°logo...
orquestador  | ‚úÖ Producto encontrado: Mouse Inal√°mbrico ($25.99)
orquestador  | ‚è≥ Paso 1/4: Creando compra...
orquestador  | ‚úÖ Paso 1/4: Compra creada - ID: abc-123
orquestador  | ‚è≥ Paso 2/4: Procesando pago...
orquestador  | ‚ö†Ô∏è  Intento 1/3 fall√≥ para pagos. Esperando 1s antes de reintentar...
orquestador  | üîÑ Reintentando pagos (intento 2/3)...
orquestador  | ‚ö†Ô∏è  Intento 2/3 fall√≥ para pagos. Esperando 2s antes de reintentar...
orquestador  | üîÑ Reintentando pagos (intento 3/3)...
orquestador  | ‚ùå Paso 2/4: Fallo al procesar pago despu√©s de 3 intentos
orquestador  | ‚ö†Ô∏è  Ejecutando compensaciones para: ['compras']
orquestador  | ‚Ü©Ô∏è  Compensando compra abc-123...
orquestador  | ‚úÖ Compra abc-123 compensada exitosamente
```

---

## üõë Paso 9: Detener los Servicios

### Detener microservicios (mantener Traefik corriendo)
```bash
docker compose down
```

### Detener todo incluyendo Traefik
```bash
docker compose down
cd traefik
docker compose down
```

### Limpiar recursos (im√°genes, vol√∫menes, etc.)
```bash
docker compose down -v --rmi all
```

---

## üèóÔ∏è Arquitectura del Sistema

### Versi√≥n Actual: 1.1.0

**Componentes:**
- **Traefik v3.1**: Reverse proxy y load balancer
- **Granian**: Servidor WSGI de alto rendimiento (Rust-based)
- **Flask 3.1.0**: Framework web para los microservicios
- **Docker Compose**: Orquestaci√≥n de contenedores
- **Red Docker**: `carlosred` (bridge externa)

**Configuraci√≥n de Workers:**
- **Orquestador**: 2 workers
- **Microservicios**: 1 worker cada uno

> **Nota sobre workers:** La versi√≥n actual usa 1 worker por microservicio para garantizar consistencia de datos con almacenamiento en memoria. Para entornos de producci√≥n con m√∫ltiples workers, se recomienda usar una base de datos compartida (PostgreSQL).

### Enrutamiento con Traefik

Traefik enruta las peticiones seg√∫n el path:
- `http://localhost/orquestador/*` ‚Üí Orquestador (puerto 5000)
- `http://localhost/ms_catalogo/*` ‚Üí ms-catalogo (puerto 5001)
- `http://localhost/ms_compras/*` ‚Üí ms-compras (puerto 5002)
- `http://localhost/ms_pagos/*` ‚Üí ms-pagos (puerto 5003)
- `http://localhost/ms_inventario/*` ‚Üí ms-inventario (puerto 5004)

---

## üîç Troubleshooting

### Los servicios no inician
```bash
# Verificar logs de errores
docker compose logs

# Verificar que Traefik est√° corriendo
docker ps | grep traefik

# Verificar que la red existe
docker network ls | grep carlosred
```

### Error "network carlosred not found"
```bash
docker network create carlosred
```

### Traefik no enruta correctamente
```bash
# Verificar logs de Traefik
cd traefik
docker compose logs -f

# Verificar que los servicios est√°n en la red carlosred
docker network inspect carlosred
```

### Puerto 80 ocupado
Otro servicio est√° usando el puerto 80. Det√©n el servicio conflictivo o cambia el puerto de Traefik en `traefik/docker-compose.yml`.

### Rebuild completo (limpiar todo y empezar de nuevo)
```bash
# Detener todo
docker compose down -v --rmi all
cd traefik
docker compose down

# Reiniciar
cd ..
docker compose up -d --build
cd traefik
docker compose up -d
```

---

## üìù Notas Adicionales

### Versionado de Im√°genes

El proyecto usa versionado sem√°ntico para las im√°genes Docker:
- `1.0.0`: Versi√≥n inicial con m√∫ltiples workers
- `1.0.1`: Ajuste de probabilidad de √©xito a 95%
- `1.1.0`: **Versi√≥n actual** - 1 worker para consistencia

Para crear nuevas versiones, actualiza los tags en `docker-compose.yml` y reconstruye:
```bash
docker compose build
docker compose up -d
```

### Variables de Ambiente

Las URLs de los microservicios se configuran mediante variables de ambiente en `docker-compose.yml`:
- `MS_CATALOGO_URL=http://ms-catalogo:5001`
- `MS_COMPRAS_URL=http://ms-compras:5002`
- `MS_PAGOS_URL=http://ms-pagos:5003`
- `MS_INVENTARIO_URL=http://ms-inventario:5004`

Esto permite la comunicaci√≥n entre contenedores usando DNS interno de Docker.

---

## üéØ Resumen de Comandos R√°pidos

```bash
# Inicio completo
docker network create carlosred
cd traefik && docker compose up -d && cd ..
docker compose up -d --build

# Prueba r√°pida
curl http://localhost/orquestador/health
curl -X POST http://localhost/orquestador/compra \
  -H "Content-Type: application/json" \
  -d '{"usuario_id": "test", "producto": "Laptop", "monto": 1500.00}'

# Ver logs
docker compose logs -f

# Detener todo
docker compose down
cd traefik && docker compose down
```
- Revisa los logs para identificar errores de importaci√≥n
